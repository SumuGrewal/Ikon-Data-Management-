<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist - Ikon Conveyancing</title>

    <style>
        /* General body styling */
        body, html {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            height: 100%;
            background-color: #f4f4f4;
        }

        /* Container and navigation */
        .container {
            display: grid;
            grid-template-columns: 250px auto;
            height: 100vh;
        }

        .navigation {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
        }

        .navigation ul {
            list-style: none;
            padding: 0;
        }

        .navigation ul li a {
            color: white;
            padding: 10px;
            display: flex;
            align-items: center;
            text-decoration: none;
        }

        .navigation ul li a:hover {
            background-color: #34495e;
        }

        .navigation ul li.active a {
            background-color: #2c3e50;
            padding: 10px;
            border-radius: 5px;
        }

        /* Main content */
        .main-content {
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
        }

        .file-list {
            list-style-type: none;
            padding: 0;
        }

        .file-list li {
            padding: 15px;
            margin-bottom: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
        }

        .file-list li:hover {
            background-color: #f1f1f1;
        }

        .file-list li.active {
            background-color: #0056b3;
            color: white;
        }

        /* Checklist Section */
        .checklist-section {
            margin-top: 20px;
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: none; /* Initially hidden */
        }

        .checklist-section h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .checklist-items {
            list-style-type: none;
            padding: 0;
        }

        .checklist-items li {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .checklist-items li input[type="checkbox"] {
            margin-right: 10px;
        }

        /* Progress bar */
        .progress-bar {
            margin-top: 20px;
            height: 25px;
            width: 100%;
            background-color: #ddd;
            border-radius: 12px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: #0056b3;
            width: 0%;
            border-radius: 12px;
            transition: width 0.5s;
        }

        /* Form for adding file */
        .add-file-form {
            margin-bottom: 20px;
            padding: 20px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .add-file-form input, .add-file-form button {
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        /* Filter section */
        .filter-section {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .filter-section input, .filter-section button {
            padding: 10px;
            margin: 5px 0;
            width: calc(100% - 20px);
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .clear-filter-btn {
            background-color: #ff4c4c;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }

        .clear-filter-btn:hover {
            background-color: #ff1a1a;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Navigation Menu -->
        <nav class="navigation">
            <ul>
                <li><a href="/dashboard"><ion-icon name="home"></ion-icon> Dashboard</a></li>
                <li><a href="/client_files"><ion-icon name="folder"></ion-icon> Client Files</a></li>
                <li><a href="/send_email"><ion-icon name="mail"></ion-icon> Send Email</a></li>
                <li><a href="/calendar"><ion-icon name="calendar"></ion-icon> Calendar</a></li>
                <li class="active"><a href="/checklist"><ion-icon name="checkmark"></ion-icon> Checklist</a></li>
                <li><a href="/logout"><ion-icon name="log-out"></ion-icon> Log-Off</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <h2>File Number Checklist</h2>

            <!-- Add File Form -->
            <div class="add-file-form">
                <input type="text" id="file-number-input" placeholder="Enter File Number">
                <input type="date" id="settlement-date-input" placeholder="Enter Settlement Date">
                <button id="add-file-button">Add File</button>
            </div>

            <!-- Filter Section -->
            <div class="filter-section">
                <label for="filter-date">Filter by Settlement Date: </label>
                <input type="date" id="filter-date">
                <button id="apply-filter">Apply Filter</button>
                <button class="clear-filter-btn" id="clear-filter">Clear Filter</button>
            </div>

            <!-- File Numbers Section -->
            <ul class="file-list">
                <!-- File numbers will be dynamically loaded here -->
            </ul>

            <!-- Checklist Section -->
            <div class="checklist-section">
                <h2>File: <span id="file-number-display">BS0000</span></h2>
                <ul class="checklist-items">
                    <li><input type="checkbox" class="check-item" data-item="Certificates Ordered"> Certificates Ordered</li>
                    <li><input type="checkbox" class="check-item" data-item="Loan Approval"> Loan Approval</li>
                    <li><input type="checkbox" class="check-item" data-item="Verification of Identity"> Verification of Identity</li>
                    <li><input type="checkbox" class="check-item" data-item="Property Inspection Complete"> Property Inspection Complete</li>
                    <li><input type="checkbox" class="check-item" data-item="Deposit Received"> Deposit Received</li>
                    <li><input type="checkbox" class="check-item" data-item="Contract Signed"> Contract Signed</li>
                    <li><input type="checkbox" class="check-item" data-item="Finance Approved"> Finance Approved</li>
                </ul>

                <!-- Progress Bar -->
                <div class="progress-bar">
                    <div class="progress-bar-fill"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript to handle the file checklist and progress bar -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const fileList = document.querySelector('.file-list');
            const fileNumberDisplay = document.getElementById('file-number-display');
            const checklistItems = document.querySelectorAll('.check-item');
            const progressBarFill = document.querySelector('.progress-bar-fill');
            const addFileButton = document.getElementById('add-file-button');
            const fileNumberInput = document.getElementById('file-number-input');
            const settlementDateInput = document.getElementById('settlement-date-input');
            const filterDateInput = document.getElementById('filter-date');
            const applyFilterButton = document.getElementById('apply-filter');
            const clearFilterButton = document.getElementById('clear-filter');
            const checklistSection = document.querySelector('.checklist-section');
            let activeFileNumber = null;
            let files = [];

            // Load files into the file list
            function loadFileNumbers(fileArray = files) {
                fileList.innerHTML = '';
                fileArray.forEach(file => {
                    const li = document.createElement('li');
                    li.textContent = `${file.fileNumber} - ${file.settlementDate}`;
                    li.addEventListener('click', () => selectFile(file.fileNumber, li));
                    fileList.appendChild(li);
                });
            }

            // Handle file selection and load checklist progress
            function selectFile(fileNumber, element) {
                // Highlight selected file and remove active class from others
                document.querySelectorAll('.file-list li').forEach(li => li.classList.remove('active'));
                element.classList.add('active');

                // Save progress for the previously active file before switching
                saveChecklistProgress();

                // Display the selected file number
                fileNumberDisplay.textContent = fileNumber;
                activeFileNumber = fileNumber;

                // Show checklist section
                checklistSection.style.display = 'block';

                // Load checklist progress for the selected file
                loadChecklistProgress(fileNumber);
            }

            // Save checklist progress to the backend
            function saveChecklistProgress() {
                if (activeFileNumber) {
                    const checklistData = Array.from(checklistItems).map(item => ({
                        description: item.dataset.item,
                        status: item.checked ? 'completed' : 'pending'
                    }));

                    fetch(`/api/save_checklist/${activeFileNumber}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ checklistStatus: checklistData })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Checklist progress saved:', data);
                    })
                    .catch(error => console.error('Error:', error));
                }
            }

            // Load checklist progress when a file is selected
            function loadChecklistProgress(fileNumber) {
                fetch(`/api/load_checklist/${fileNumber}`)
                    .then(response => response.json())
                    .then(data => {
                        checklistItems.forEach(item => {
                            const status = data.checklistStatus.find(checklistItem => checklistItem.description === item.dataset.item);
                            item.checked = status && status.status === 'completed';
                        });
                        updateProgressBar();
                    })
                    .catch(error => console.error('Error:', error));
            }

            // Update the progress bar based on checked items
            function updateProgressBar() {
                const totalItems = checklistItems.length;
                const checkedItems = document.querySelectorAll('.check-item:checked').length;
                const progressPercentage = (checkedItems / totalItems) * 100;
                progressBarFill.style.width = `${progressPercentage}%`;
            }

            // Attach change event to checklist items
            checklistItems.forEach(item => {
                item.addEventListener('change', updateProgressBar);
            });

            // Handle adding a new file
            addFileButton.addEventListener('click', function () {
                const fileNumber = fileNumberInput.value;
                const settlementDate = settlementDateInput.value;

                if (fileNumber && settlementDate) {
                    files.push({ fileNumber, settlementDate });
                    loadFileNumbers();
                    fileNumberInput.value = '';
                    settlementDateInput.value = '';

                    // Save the file and its checklist to the backend
                    fetch('/api/client_files', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ fileNumber, settlementDate })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('File saved:', data);
                    })
                    .catch(error => console.error('Error:', error));
                }
            });

            // Handle filter by date
            applyFilterButton.addEventListener('click', function () {
                const filterDate = filterDateInput.value;

                if (filterDate) {
                    const filteredFiles = files.filter(file => file.settlementDate <= filterDate);
                    loadFileNumbers(filteredFiles);
                }
            });

            // Handle clear filter button
            clearFilterButton.addEventListener('click', function () {
                filterDateInput.value = '';  // Clear the filter input
                loadFileNumbers();  // Reload all files
            });

            // Initialize the page by loading file numbers
            fetch('/api/client_files')
                .then(response => response.json())
                .then(data => {
                    files = data;
                    loadFileNumbers();
                })
                .catch(error => console.error('Error:', error));
        });
    </script>
</body>

</html>
